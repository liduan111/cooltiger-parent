<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.kyj.cooltiger.cooltigerproduct.mapper.ProductInfoMapper">

    <!-- 根据店铺ID查询总条数 -->
    <select id="getTotalCountByStoreId" resultType="int">
        SELECT COUNT(1)
        FROM ky_product_info
        WHERE store_id = #{storeId}
        <if test="categoryId != null and categoryId != ''">
            AND category_id = #{categoryId}
        </if>
        <if test="keyword != null and keyword != ''">
            AND product_code = #{keyword} OR title like CONCAT('%', #{keyword}, '%')
        </if>
    </select>

    <!-- 根据店铺ID查询商品列表 -->
    <select id="getProductInfoListByStoreId" resultType="com.kyj.cooltiger.cooltigerfeign.product.vo.ProductInfoListByStoreIdRespVo">
        SELECT
        pro.product_id productId,
        pro.product_code productCode,
        pro.title,
        pro.modified_time modifiedTime,
        pic.url,
        sku.sale_price minPrice,
        sku.stock
        FROM ky_product_info pro
        LEFT JOIN ky_product_picture pic ON pro.product_id = pic.relation_id AND pic.is_main = 1
        LEFT JOIN ky_product_sku sku
        ON (SELECT MIN(sale_price) FROM ky_product_sku WHERE product_id = pro.product_id)
        AND (SELECT SUM(stock) FROM ky_product_sku WHERE product_id = pro.product_id)
        WHERE pro.store_id = #{storeId}
        <if test="categoryId != null and categoryId != ''">
            AND category_id = #{categoryId}
        </if>
        <if test="keyword != null and keyword != ''">
            AND product_code = #{keyword} OR title like CONCAT('%', #{keyword}, '%')
        </if>
        LIMIT #{pageSatrt},#{pageSize}
    </select>

    <!-- 添加商品基本信息 -->
    <insert id="addProductInfo" parameterType="ProductInfo" useGeneratedKeys="true" keyProperty="productId">
        INSERT INTO ky_product_info
        (product_code, title, store_id, brand_id, category_id, address_from_id,
         create_address_id, about_deliver_time, service_ids, shelf_status,
         audit_status, deleted)
        VALUES
        (#{productInfo.productCode}, #{productInfo.title}, #{productInfo.storeId},
         #{productInfo.brandId}, #{productInfo.categoryId}, #{productInfo.addressFromId},
         #{productInfo.createAddressId}, #{productInfo.aboutDeliverTime},
         #{productInfo.serviceIds}, #{productInfo.shelfStatus}, #{productInfo.auditStatus},
         #{productInfo.deleted})
    </insert>

</mapper>